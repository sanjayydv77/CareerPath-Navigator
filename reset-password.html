<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Future-Fit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Add some specific styles for this page */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .reset-container {
            background: #fff;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }

        .reset-container h2 {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 1rem;
        }

        .reset-container p {
            color: #666;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }
        
        /* Using your existing form styles from styles.css */
        .form-group {
            text-align: left;
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            font-weight: 600;
        }

        /* Message area for success or error */
        #message {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            display: none; /* Hidden by default */
            margin-bottom: 1rem;
            font-weight: 500;
        }
        #message.success {
            background-color: #d4edda;
            color: #155724;
        }
        #message.error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>

    <div class="reset-container">
        <h2>Set a New Password</h2>
        <p>Please enter your new password below. Make sure it's secure!</p>
        
        <div id="message"></div>

        <form id="resetForm">
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" class="form-group input" id="newPassword" placeholder="Enter new password" required>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" class="form-group input" id="confirmPassword" placeholder="Confirm new password" required>
            </div>
            
            <ul id="passwordRequirements" class="password-requirements" style="text-align: left; margin-bottom: 1.5rem;">
                <li id="pw-length" class="invalid"><i class="fas fa-times"></i> At least 8 characters</li>
                <li id="pw-upper" class="invalid"><i class="fas fa-times"></i> One uppercase letter</li>
                <li id="pw-lower" class="invalid"><i class="fas fa-times"></i> One lowercase letter</li>
                <li id="pw-number" class="invalid"><i class="fas fa-times"></i> One number</li>
                <li id="pw-special" class="invalid"><i class="fas fa-times"></i> One special character</li>
            </ul>

            <button type="submit" class="submit-btn" id="resetButton">
                <i class="fas fa-save"></i> Save New Password
            </button>
        </form>
        
        <p style="margin-top: 1.5rem; font-size: 0.9rem;">
            Remembered your password? <a href="index.html" style="color: #667eea;">Back to Login</a>
        </p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const resetForm = document.getElementById('resetForm');
            const messageDiv = document.getElementById('message');
            const resetButton = document.getElementById('resetButton');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');

            // 1. Get the token from the URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                showMessage('error', 'Invalid or missing token. Please request a new reset link.');
                resetButton.disabled = true;
            }

            // 2. Add listener to the form
            resetForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                // --- Client-side validation ---
                if (newPassword !== confirmPassword) {
                    showMessage('error', 'Passwords do not match. Please try again.');
                    return;
                }
                if (!allPasswordReqsMet()) {
                    showMessage('error', 'Password does not meet all requirements.');
                    return;
                }
                // --- End validation ---

                resetButton.innerHTML = '<span class="loading"></span> Saving...';
                resetButton.disabled = true;

                try {
                    // 3. Send token and new password to the backend
                    const response = await fetch('http://localhost:5000/api/auth/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token: token,
                            password: newPassword
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage('success', data.msg + ' Redirecting to login...');
                        // Redirect to login page after 3 seconds
                        setTimeout(() => {
                            window.location.href = 'index.html?verified=true'; // Reuse verified param to open login modal
                        }, 3000);
                    } else {
                        showMessage('error', data.msg); // "Token is invalid or has expired"
                        resetButton.innerHTML = '<i class="fas fa-save"></i> Save New Password';
                        resetButton.disabled = false;
                    }

                } catch (error) {
                    console.error('Reset Password Error:', error);
                    showMessage('error', 'Network error. Is the backend server running?');
                    resetButton.innerHTML = '<i class="fas fa-save"></i> Save New Password';
                    resetButton.disabled = false;
                }
            });

            // --- Password validation UI (copied from your index.html) ---
            const pwReqs = {
                length: document.getElementById('pw-length'),
                upper: document.getElementById('pw-upper'),
                lower: document.getElementById('pw-lower'),
                number: document.getElementById('pw-number'),
                special: document.getElementById('pw-special')
            };

            newPasswordInput.addEventListener('input', () => {
                allPasswordReqsMet(); // Just to update the UI
            });

            function allPasswordReqsMet() {
                const val = newPasswordInput.value;
                const checks = {
                    length: val.length >= 8,
                    upper: /[A-Z]/.test(val),
                    lower: /[a-z]/.test(val),
                    number: /[0-9]/.test(val),
                    special: /[^A-Za-z0-9]/.test(val)
                };
                Object.keys(pwReqs).forEach(key => {
                    if (checks[key]) {
                        pwReqs[key].classList.add('valid');
                        pwReqs[key].classList.remove('invalid');
                        pwReqs[key].querySelector('i').className = 'fas fa-check';
                    } else {
                        pwReqs[key].classList.remove('valid');
                        pwReqs[key].classList.add('invalid');
                        pwReqs[key].querySelector('i').className = 'fas fa-times';
                    }
                });
                return Object.values(checks).every(Boolean);
            }
            
            // Helper function to show messages
            function showMessage(type, text) {
                messageDiv.textContent = text;
                messageDiv.className = type;
                messageDiv.style.display = 'block';
            }
        });
    </script>
</body>
</html>